<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-43TMHBXPHM"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-43TMHBXPHM');
    </script>

    <link rel="icon" href="resources/neko.ico" type="image/x-icon">

    <title>光棱坦克工厂</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="styles/style.css?v=1.0.0">
    <script src="scripts/DefaultArguments.js?v=1.0.0"></script>
    <script src="scripts/MirageDecoder.js?v=1.0.0"></script>
    <script src="scripts/MirageEncoder.js?v=1.0.0"></script>
    <script>
        function applyTheme() {
            const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)").matches;
            const theme = prefersDarkScheme ? "dark" : "light";
            document.documentElement.setAttribute("data-theme", theme);
        }
        window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", applyTheme);
    </script>
</head>

<body>
    <h1 class="title">光棱坦克工厂</h1>

    <div class="link" id="infoLink">
        <small><a href="https://tieba.baidu.com/p/9093709508" target="_blank">什么是光棱坦克？</a></small>
    </div>

    <div class="PageContainer">

        <div class="TitleContainer">
            <button class="PageSwitchButton" id="decodeButton"><b>显形</b></button>
            <button class="PageSwitchButton" id="encodeButton"><b>制作</b></button>
        </div>

        <div class="DisplayArea" id="decodePage">
            <div id="decodeMethodSelect">
                <label for="optionSelect">1. 选择表图像素处理方式: </label>
                <select id="optionSelect">
                    <option value="black">置为黑色</option>
                    <option value="white">置为白色</option>
                    <option value="trans">置为透明</option>
                    <option value="lcopy">左侧复制</option>
                    <option value="ucopy">上方复制</option>
                    <option value="luavg">左上平均</option>
                </select>
            </div>

            <div id="decodeImageSelect">
                <div id="decodeFileInput">
                    <div>2.</div>
                    <label for="decodeImageFileInput" class="fileInputLabel">选择图片文件</label>
                    <input type="file" id="decodeImageFileInput" accept="image/*">
                </div>
                <div id="decodeUrlInput">
                    <label for="decodeImageUrlInput">或:</label>
                    <input type="text" id="decodeImageUrlInput" placeholder="输入图片URL">
                    <button id="decodeLoadImageButton">加载图片</button>
                </div>
                <div id="decodePasteInput">
                    或从剪贴板粘贴图片 (ctrl+v),
                </div>
                <div id="decodeDragInputHint">
                    或直接将图片拖进窗口。
                </div>
            </div>

            <canvas id="decodeCanvas"></canvas>

            <div class="decodeSlider">
                <label for="decodeThresholdRange">3. 滑动直至图像清晰: </label>
                <input type="range" id="decodeThresholdRange" min="0" max="255">
            </div>

            <div class="checkbox" id="decodeReverseCheckbox">
                <input type="checkbox" id="decodeReverseInput">
                <label for="decodeReverseInput">是否为反色阶隐写</label>
            </div>

            <div id="saveButton">
                <button id="decodeSaveImageButton">保存当前显示图像</button>
            </div>
        </div>

        <div class="DisplayArea" id="encodePage">
            <div id="encodeSourceInput">
                <div class="encodeFileInput" , id="innerFileInput">
                    <label for="innerSourceFileInput" class="fileInputLabel">选择里图文件</label>
                    <input type="file" id="innerSourceFileInput" accept="image/*">
                    <label for="innerSourceFileInput" class="encodeDrag">或直接拖动至下方画布</label>
                    <label for="innerSourceFileInput" class="encodeDrag">或在下方画布处ctrl+v</label>
                    <canvas id="innerCanvas"></canvas>
                    <slider class="encodeSlider">
                        <label for="innerThresholdRange" class="encodeSliderTitle">里图色阶端点: </label>
                        <label for="innerThresholdRange">(越小隐写效果越好)</label>
                        <label for="innerThresholdRange">(但越小里图质量越差)</label>
                        <input id="innerThresholdRange" type="range" min="0" max="128">
                        <label for="innerThresholdRange">(不应高于右侧值)</label>
                    </slider>
                    <div class="thresInput">
                        <label for="innerThresholdInput">当前值: </label>
                        <input type="number" id="innerThresholdInput">
                    </div>
                </div>

                <div class="encodeFileInput" , id="coverFileInput">
                    <label for="coverSourceFileInput" class="fileInputLabel">选择表图文件</label>
                    <input type="file" id="coverSourceFileInput" accept="image/*">
                    <label for="coverSourceFileInput" class="encodeDrag">或直接拖动至下方画布</label>
                    <label for="coverSourceFileInput" class="encodeDrag">或在下方画布处ctrl+v</label>
                    <canvas id="coverCanvas"></canvas>
                    <slider class="encodeSlider">
                        <label for="coverThresholdRange" class="encodeSliderTitle">表图色阶端点: </label>
                        <label for="coverThresholdRange">(越大显形效果越好)</label>
                        <label for="coverThresholdRange">(但越大表图质量越差)</label>
                        <input type="range" id="coverThresholdRange" min="0" max="128">
                        <label for="coverThresholdRange">(不应低于左侧值)</label>
                    </slider>
                    <div class="thresInput">
                        <label for="coverThresholdInput">当前值: </label>
                        <input type="number" id="coverThresholdInput">
                    </div>
                </div>
            </div>

            <checkbox id="isCoverGray">
                <input type="checkbox" id="isCoverGrayCheckBox">
                <label for="isCoverGrayCheckBox">表图是否取灰度</label>
            </checkbox>

            <div id="isEncodeReverse">
                <input type="checkbox" id="isEncodeReverseCheckBox">
                <label for="isEncodeReverseCheckBox">是否反色阶隐写</label>
            </div>

            <canvas id="outputCanvas"></canvas>

            <div id="encodeMethod">
                <label for="encodeMethodSelect">选择像素混合方式: </label>
                <select id="encodeMethodSelect">
                    <option value="chess">棋盘布局</option>
                    <option value="gap_2">2像素间隔斜线</option>
                    <option value="gap_3">3像素间隔斜线</option>
                    <option value="gap_5">5像素间隔斜线</option>
                    <option value="col_1">1像素间隔竖线</option>
                    <option value="row_1">1像素间隔横线</option>
                </select>
            </div>

            <div id="encodeOutputSizeLimit">
                <label for="encodeSizeInput">输出图像最大长或宽 <small>(并非越大越好):</small> </label>
                <input id="encodeSizeInput" type="number" value="1200">
            </div>

            <div id="isPng">
                <input type="checkbox" id="isPngCheckBox">
                <label for="isPngCheckBox">存为PNG <small>(否则为JPEG, 但被平台强制压缩几率更低)</small></label>
            </div>

            <div id="jumpButton">
                <button id="jumpToDecodeButton">以当前结果跳转显形测试</button>
            </div>

            <div id="saveButton">
                <button id="encodeSaveImageButton">保存结果</button>
            </div>
        </div>

        <div class="link" , id="hintLink">
            <small><a href="https://github.com/Uyanide/Mirage_Decode/issues/new" target="_blank">Bug反馈</a></small>
        </div>

        <div class="link" , id="profileLink">
            <small><a href="https://github.com/Uyanide" target="_blank">Github - Uyanide (我)</a></small>
        </div>

        <div class="link" , id="repoLink">
            <small><a href="https://github.com/Uyanide/Mirage_Decode/tree/main" target="_blank">Github -
                    Mirage_Decode (本项目)</a></small>
        </div>

        <div id="privacyButton">
            <button id="togglePrivacyPolicy">显示隐私说明</button>
        </div>

        <div id="privacyPolicy">
            <p>本网站使用Google Analytics记录访问者的行为。通过使用本网站，您同意数据按照Google Analytics的条款和隐私政策进行处理。更多信息，请访问:<a
                    href="https://policies.google.com/privacy" target="_blank">Google
                    Analytics的隐私政策。</a></p>
        </div>

        <script>
            const version = '1.0.3';
            (() => {
                console.log('target version:', version);
                console.log('current version:', localStorage.getItem('version'));
                const previousVersion = localStorage.getItem('version');
                if (!previousVersion || previousVersion !== version) {
                    console.log('new version detected, clearing cache');
                    localStorage.clear();
                    localStorage.setItem('version', version);
                    location.reload(true);
                }
            })();
        </script>

        <script>
            const isOnPhone = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            let currCanvasIndex = 0; // 0: decode, 1: inner, 2: cover 用于错误处理
            let currPageId;  // 当前页面ID
            var isPng; // 是否将制作结果保存为PNG

            /**************************初始化**************************/

            const defaultArguments = new DefaultArguments();
            let mirageDecoder, mirageEncoder, defaultSrc;
            document.addEventListener('DOMContentLoaded', async () => {
                try {
                    // 加载默认参数
                    await defaultArguments.loadDefaultArguments();
                    defaultSrc = defaultArguments.defaultSrc;
                    defaultArguments.setDefaultValues();
                    isPng = defaultArguments.isPng;

                    // 实例化解码器和编码器
                    mirageDecoder = new MirageDecoder('decodeCanvas', defaultArguments);
                    mirageEncoder = new MirageEncoder('innerCanvas', 'coverCanvas', 'outputCanvas', defaultArguments);

                    // 判定并更换明暗主题
                    applyTheme();

                    // 加载默认图像
                    const defaultImg = new Image();
                    defaultImg.crossOrigin = 'anonymous';
                    defaultImg.alt = 'default image';
                    updateImageFromFile(defaultSrc[0], (img) => {
                        mirageDecoder.updateImage(img);
                    });

                    updateImageFromFile(defaultSrc[1], (img) => {
                        mirageEncoder.updateInnerImage(img);
                    });

                    updateImageFromFile(defaultSrc[2], (img) => {
                        mirageEncoder.updateCoverImage(img);
                    });

                    // 设置全局事件监听器
                    universalSetupEventListeners();

                    // 显示默认页面
                    switch (defaultArguments.defaultPageId) {
                        case 'encodePage':
                            encodeSetUpEventListeners();
                            document.getElementById('decodePage').style.display = 'none';
                            document.getElementById('encodePage').style.display = 'flex';
                            document.getElementById('encodeButton').classList.add('PageSwitchButtonSelected');
                            document.getElementById('decodeButton').classList.add('PageSwitchButtonUnselected');
                            break;
                        case 'decodePage':
                            decodeSetupEventListeners();
                            document.getElementById('encodePage').style.display = 'none';
                            document.getElementById('decodePage').style.display = 'flex';
                            document.getElementById('decodeButton').classList.add('PageSwitchButtonSelected');
                            document.getElementById('encodeButton').classList.add('PageSwitchButtonUnselected');
                            break;
                    }
                    currPageId = defaultArguments.defaultPageId;

                    if (isOnPhone) {
                        document.getElementById('decodePasteInput').style.display = 'none';
                        document.getElementById('decodeDragInputHint').style.display = 'none';
                        const elements = document.getElementsByClassName('encodeDrag');
                        for (let i = 0; i < elements.length; i++) {
                            elements[i].style.display = 'none';
                        }
                    }
                } catch (error) {
                    console.error('Failed to load default arguments:', error);
                }
            });

            /************************通用功能函数***********************/

            function handleImageLoadError(error, callback) {
                console.error('图像加载失败:', error);
                alert('无法加载图像, 请确定文件类型和状态。');
                loadImage(defaultSrc[currCanvasIndex]).then((img) => {
                    callback(img);
                });
            }

            // 从源加载图像并返回
            async function loadImage(input) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = reject;

                    if (typeof input === 'string') {
                        img.crossOrigin = 'anonymous';
                        img.src = input;
                    } else if (input instanceof File) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            img.src = e.target.result;
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(input);
                    } else {
                        reject(new Error('不支持的输入类型'));
                    }
                });
            }

            // 从文件加载图像，调用callback
            async function updateImageFromFile(file, callback) {
                loadImage(file).then((img) => {
                    callback(img);
                }).catch((error) => {
                    handleImageLoadError(error, callback);
                });
            }

            // 从URL加载图像，调用callback
            async function updateImageFromURL(event, callback) {
                const imageUrl = event.target.previousElementSibling.value;
                loadImage(imageUrl).then((img) => {
                    callback(img);
                }).catch((error) => {
                    handleImageLoadError(error, callback);
                });
            }

            // 从剪贴板更新图像，调用callback
            async function updateImageFromClipboard(event, callback) {
                const items = (event.clipboardData || event.originalEvent.clipboardData).items;
                for (const item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        const blob = item.getAsFile();
                        loadImage(blob).then((img) => {
                            callback(img);
                        }).catch((error) => {
                            handleImageLoadError(error, callback);
                        });
                    }
                }
            }

            // 拖动文件加载图像
            async function dragDropLoadImage(event, callback) {
                event.preventDefault();
                if (event.dataTransfer.items) {
                    for (const item of event.dataTransfer.items) {
                        if (item.kind === 'file') {
                            const file = item.getAsFile();
                            loadImage(file).then((img) => {
                                callback(img);
                            }).catch((error) => {
                                handleImageLoadError(error, callback);
                            });
                        }
                    }
                }
            }

            // 禁用滚动
            var scrollPosition = 0;
            function disableScroll() {
                document.addEventListener('mouseup', enableScroll);
                scrollPosition = window.pageYOffset;
                window.onscroll = function () {
                    window.scrollTo(0, scrollPosition);
                };
            }

            // 恢复滚动
            function enableScroll() {
                window.onscroll = null;
                document.removeEventListener('mouseup', enableScroll);
            }

            // 保存图像
            function saveImageFromCanvas(canvasId, isPng = true) {
                const canvas = document.getElementById(canvasId);
                const link = document.createElement('a');
                if (isPng) {
                    link.href = canvas.toDataURL('image/png');
                    link.download = 'output.png';
                }
                else {
                    link.href = canvas.toDataURL('image/jpeg', 1);
                    link.download = 'output.jpg';
                }
                link.click();
            }

            // 切换页面显示
            function switchPage() {
                var decodePage = document.getElementById('decodePage');
                var encodePage = document.getElementById('encodePage');
                var decodeButton = document.getElementById('decodeButton');
                var encodeButton = document.getElementById('encodeButton');
                if (currPageId === 'decodePage') {
                    encodePage.style.display = 'flex';
                    decodePage.style.display = 'none';
                    decodeButton.classList.remove('PageSwitchButtonSelected');
                    decodeButton.classList.add('PageSwitchButtonUnselected');
                    encodeButton.classList.remove('PageSwitchButtonUnselected');
                    encodeButton.classList.add('PageSwitchButtonSelected');
                    decodeRemoveEventListeners();
                    encodeSetUpEventListeners();
                    currPageId = 'encodePage';
                } else {
                    decodePage.style.display = 'flex';
                    encodePage.style.display = 'none';
                    decodeButton.classList.remove('PageSwitchButtonUnselected');
                    decodeButton.classList.add('PageSwitchButtonSelected');
                    encodeButton.classList.remove('PageSwitchButtonSelected');
                    encodeButton.classList.add('PageSwitchButtonUnselected');
                    decodeSetupEventListeners();
                    encodeRemoveEventListeners();
                    currPageId = 'decodePage';
                }
            }

            function universalSetupEventListeners() {
                // 隐私政策按钮事件监听
                document.getElementById('togglePrivacyPolicy').addEventListener('click', (event) => {
                    const privacyPolicy = document.getElementById('privacyPolicy');
                    const state = window.getComputedStyle(privacyPolicy).display;
                    if (state === 'none') {
                        privacyPolicy.style.display = 'block';
                        event.target.textContent = '隐藏隐私说明';
                        window.scrollTo(0, document.body.scrollHeight);
                    } else {
                        privacyPolicy.style.display = 'none';
                        event.target.textContent = '显示隐私说明';
                    }
                });

                // 禁用拖动默认事件
                document.addEventListener('dragover', (event) => {
                    event.preventDefault();
                });
            }

            /************************解码事件监听************************/

            // 从文件加载图像
            function decodeLoadImageFile(event) {
                const file = event.target.files[0];
                currCanvasIndex = 0;
                updateImageFromFile(file, (img) => {
                    mirageDecoder.updateImage(img);
                });
            }

            // 从URL加载图像
            function decodeLoadImageURL(event) {
                currCanvasIndex = 0;
                updateImageFromURL(event, (img) => {
                    mirageDecoder.updateImage(img);
                });
            }

            // 从剪贴板加载图像
            function decodeLoadImageFromClipboard(event) {
                currCanvasIndex = 0;
                updateImageFromClipboard(event, (img) => {
                    mirageDecoder.updateImage(img);
                });
            }

            // 从拖动加载图像
            function decodeLoadImageFromDrag(event) {
                currCanvasIndex = 0;
                dragDropLoadImage(event, (img) => {
                    mirageDecoder.updateImage(img);
                });
            }

            // 设置阈值
            function decodeSetThreshold(event) {
                mirageDecoder.threshold = parseInt(event.target.value, 10);
                if (mirageDecoder.img) {
                    mirageDecoder.processImage();
                }
            }

            // 设置表图像素处理方式
            function decodeSetCoverMethod(event) {
                mirageDecoder.coverProcessMethod = event.target.value;
                if (mirageDecoder.img) {
                    mirageDecoder.processImage();
                }
            }

            // 设置反向隐写
            function decodeSetReverse(event) {
                mirageDecoder.reverse = event.target.checked;
                if (mirageDecoder.img) {
                    mirageDecoder.processImage();
                }
            }

            // 保存图像
            function decodeSaveImage() {
                saveImageFromCanvas('decodeCanvas');
            }

            // 设置解码事件监听器
            function decodeSetupEventListeners() {
                // 图像加载事件监听
                document.getElementById('decodeImageFileInput').addEventListener('change', decodeLoadImageFile);
                document.getElementById('decodeLoadImageButton').addEventListener('click', decodeLoadImageURL);
                if (!isOnPhone) {
                    window.addEventListener('paste', decodeLoadImageFromClipboard);
                    document.body.addEventListener('drop', decodeLoadImageFromDrag);
                }
                // 参数调整事件监听
                document.getElementById('decodeThresholdRange').addEventListener('input', decodeSetThreshold);
                document.getElementById('decodeMethodSelect').addEventListener('change', decodeSetCoverMethod);
                document.getElementById('decodeReverseInput').addEventListener('change', decodeSetReverse);

                // 保存图像
                document.getElementById('decodeSaveImageButton').addEventListener('click', decodeSaveImage);

                // 禁用滚动
                document.getElementById('decodeThresholdRange').addEventListener('mousedown', disableScroll);

                // 切换页面
                document.getElementById('encodeButton').addEventListener('click', switchPage);
            }

            // 移除解码事件监听器
            function decodeRemoveEventListeners() {
                document.getElementById('decodeImageFileInput').removeEventListener('change', decodeLoadImageFile);
                document.getElementById('decodeLoadImageButton').removeEventListener('click', decodeLoadImageURL);
                if (!isOnPhone) {
                    window.removeEventListener('paste', decodeLoadImageFromClipboard);
                    document.body.removeEventListener('drop', decodeLoadImageFromDrag);
                }
                document.getElementById('decodeThresholdRange').removeEventListener('input', decodeSetThreshold);
                document.getElementById('decodeMethodSelect').removeEventListener('change', decodeSetCoverMethod);
                document.getElementById('decodeReverseInput').removeEventListener('change', decodeSetReverse);
                document.getElementById('decodeSaveImageButton').removeEventListener('click', decodeSaveImage);
                document.getElementById('decodeThresholdRange').removeEventListener('mousedown', disableScroll);
                document.getElementById('encodeButton').removeEventListener('click', switchPage);
            }

            /********************编码事件监听*********************/

            // 从文件加载里图
            function encodeLoadInnerImageFile(event) {
                currCanvasIndex = 1;
                const file = event.target.files[0];
                updateImageFromFile(file, (img) => {
                    mirageEncoder.updateInnerImage(img);
                });
            }

            // 从文件加载表图
            function encodeLoadCoverImageFile(event) {
                currCanvasIndex = 2;
                const file = event.target.files[0];
                updateImageFromFile(file, (img) => {
                    mirageEncoder.updateCoverImage(img);
                });
            }

            // 从剪贴板加载表里图
            var mouseX = 0;
            function updateMousePosition(event) {
                mouseX = event.clientX;
            }
            function encodeLoadImageFromClipboard(event) {
                if (mouseX < window.innerWidth / 2) {
                    currCanvasIndex = 1;
                    updateImageFromClipboard(event, (img) => {
                        mirageEncoder.updateInnerImage(img);
                    });
                } else {
                    currCanvasIndex = 2;
                    updateImageFromClipboard(event, (img) => {
                        mirageEncoder.updateCoverImage(img);
                    });
                }
            }

            // 从拖动加载里图
            function encodeLoadInnerImageFromDrag(event) {
                currCanvasIndex = 1;
                dragDropLoadImage(event, (img) => {
                    mirageEncoder.updateInnerImage(img);
                });
            }

            // 从拖动加载表图
            function encodeLoadCoverImageFromDrag(event) {
                currCanvasIndex = 2;
                dragDropLoadImage(event, (img) => {
                    mirageEncoder.updateCoverImage(img);
                });
            }

            // 设置里图色阶
            function encodeSetInnerThreshold() {
                const slider = document.getElementById('innerThresholdRange');
                const text = document.getElementById('innerThresholdInput');
                mirageEncoder.innerThreshold = parseInt(slider.value, 10);
                text.value = mirageEncoder.innerThreshold;
                if (mirageEncoder.innerThreshold > mirageEncoder.coverThreshold) {
                    mirageEncoder.innerThreshold = mirageEncoder.coverThreshold;
                    slider.value = mirageEncoder.coverThreshold;
                    text.value = mirageEncoder.coverThreshold;
                    text.style.color = '#ff5e5e';
                } else {
                    text.style.color = '#dfdfdf';
                }
                if (mirageEncoder.innerImg && mirageEncoder.coverImg) {
                    mirageEncoder.processImage();
                }
            }

            // 设置表图色阶
            function encodeSetCoverThreshold() {
                const slider = document.getElementById('coverThresholdRange');
                const text = document.getElementById('coverThresholdInput');
                mirageEncoder.coverThreshold = parseInt(slider.value, 10);
                text.value = mirageEncoder.coverThreshold;
                if (mirageEncoder.innerThreshold > mirageEncoder.coverThreshold) {
                    mirageEncoder.coverThreshold = mirageEncoder.innerThreshold;
                    slider.value = mirageEncoder.innerThreshold;
                    text.value = mirageEncoder.innerThreshold;
                    text.style.color = '#ff5e5e';
                } else {
                    text.style.color = '#dfdfdf';
                }
                if (mirageEncoder.innerImg && mirageEncoder.coverImg) {
                    mirageEncoder.processImage();
                }
            }

            // 设置里图色阶输入
            let innerInputTimeout;
            function encodeSetInnerThresholdInput() {
                clearTimeout(innerInputTimeout);
                setTimeout(function () {
                    const input = document.getElementById('innerThresholdInput');
                    const slider = document.getElementById('innerThresholdRange');
                    input.style.color = '#dfdfdf';
                    const inputVal = parseInt(input.value, 10);
                    if (isNaN(inputVal)) {
                        return;
                    }
                    mirageEncoder.innerThreshold = inputVal;
                    if (mirageEncoder.innerThreshold > 128) {
                        mirageEncoder.innerThreshold = 128;
                        input.value = 128;
                    } else if (mirageEncoder.innerThreshold < 0) {
                        mirageEncoder.innerThreshold = 0;
                        input.value = 0;
                    }
                    slider.value = mirageEncoder.innerThreshold;
                    if (mirageEncoder.innerThreshold > mirageEncoder.coverThreshold) {
                        mirageEncoder.innerThreshold = mirageEncoder.coverThreshold;
                        slider.value = mirageEncoder.coverThreshold;
                        input.value = mirageEncoder.coverThreshold;
                    }
                    if (mirageEncoder.innerImg && mirageEncoder.coverImg) {
                        mirageEncoder.processImage();
                    }
                }, 500);
            }

            // 设置表图色阶输入
            let coverInputTimeout;
            function encodeSetCoverThresholdInput() {
                clearTimeout(coverInputTimeout);
                setTimeout(function () {
                    const input = document.getElementById('coverThresholdInput');
                    const slider = document.getElementById('coverThresholdRange');
                    input.style.color = '#dfdfdf';
                    const inputVal = parseInt(input.value, 10);
                    if (isNaN(inputVal)) {
                        return;
                    }
                    mirageEncoder.coverThreshold = inputVal;
                    if (mirageEncoder.coverThreshold > 128) {
                        mirageEncoder.coverThreshold = 128;
                        input.value = 128;
                    } else if (mirageEncoder.coverThreshold < 0) {
                        mirageEncoder.coverrThreshold = 0;
                        input.value = 0;
                    }
                    slider.value = mirageEncoder.coverThreshold;
                    if (mirageEncoder.innerThreshold > mirageEncoder.coverThreshold) {
                        mirageEncoder.coverThreshold = mirageEncoder.innerThreshold;
                        slider.value = mirageEncoder.coverThreshold;
                        input.value = mirageEncoder.coverThreshold;
                    }
                    if (mirageEncoder.innerImg && mirageEncoder.coverImg) {
                        mirageEncoder.processImage();
                    }
                }, 500);
            }

            // 设置表图是否取灰度
            function encodeSetCoverGray(event) {
                mirageEncoder.isCoverGray = event.target.checked;
                if (mirageEncoder.coverImg && mirageEncoder.innerImg) {
                    mirageEncoder.updateCoverImage(mirageEncoder.coverImg);
                }
            }

            // 设置是否反向隐写
            function encodeSetEncodeReverse(event) {
                mirageEncoder.isEncodeReverse = event.target.checked;
                if (mirageEncoder.innerImg && mirageEncoder.coverImg) {
                    mirageEncoder.processImage();
                }
            }

            // 设置像素混合方式
            function encodeSetMethod(event) {
                mirageEncoder.method = event.target.value;
                if (mirageEncoder.innerImg && mirageEncoder.coverImg) {
                    mirageEncoder.updateInnerImage(mirageEncoder.innerImg);
                }
            }

            // 设置输出图像大小
            let sizeInputTimeout;
            function encodeSetSize(event) {
                clearTimeout(sizeInputTimeout);

                sizeInputTimeout = setTimeout(function () {
                    mirageEncoder.size = parseInt(event.target.value, 10);
                    if (isNaN(mirageEncoder.size)) {
                        return;
                    }
                    if (mirageEncoder.size > 4000) {
                        mirageEncoder.size = 4000;
                        event.target.value = 4000;
                    } else if (mirageEncoder.size < 100) {
                        mirageEncoder.size = 100;
                        event.target.value = 100;
                    }
                    if (mirageEncoder.innerImg) {
                        mirageEncoder.updateInnerImage(mirageEncoder.innerImg);
                    }
                }, 500);
            }

            // 设置保存类型
            function setSaveType(event) {
                isPng = event.target.checked;
            }

            // 保存图像
            function encodeSaveImage() {
                saveImageFromCanvas('outputCanvas', isPng);
            }

            // 以当前结果跳转显形界面
            function jumpToDecode() {
                if (mirageEncoder.innerImg && mirageEncoder.coverImg) {
                    document.getElementById('decodeReverseInput').checked = mirageEncoder.isEncodeReverse;
                    mirageDecoder.reverse = mirageEncoder.isEncodeReverse;
                    if (mirageDecoder.reverse) {
                        document.getElementById('decodeThresholdRange').value = 255 - mirageEncoder.innerThreshold;
                        mirageDecoder.threshold = 255 - mirageEncoder.innerThreshold;
                    } else {
                        document.getElementById('decodeThresholdRange').value = mirageEncoder.innerThreshold;
                        mirageDecoder.threshold = mirageEncoder.innerThreshold;
                    }
                    const canvas = document.getElementById('outputCanvas');
                    const img = new Image();
                    img.src = canvas.toDataURL('image/png');
                    img.onload = function () {
                        mirageDecoder.updateImage(img);
                        switchPage();
                    };
                }
            }

            // 设置编码事件监听器
            function encodeSetUpEventListeners() {

                document.getElementById('decodeButton').addEventListener('click', switchPage);

                document.getElementById('innerSourceFileInput').addEventListener('change', encodeLoadInnerImageFile);
                document.getElementById('coverSourceFileInput').addEventListener('change', encodeLoadCoverImageFile);
                if (!isOnPhone) {
                    window.addEventListener('mousemove', updateMousePosition);
                    window.addEventListener('paste', encodeLoadImageFromClipboard);

                    document.getElementById('innerCanvas').addEventListener('drop', encodeLoadInnerImageFromDrag);
                    document.getElementById('coverCanvas').addEventListener('drop', encodeLoadCoverImageFromDrag);
                }

                document.getElementById('innerThresholdRange').addEventListener('input', encodeSetInnerThreshold);
                document.getElementById('coverThresholdRange').addEventListener('input', encodeSetCoverThreshold);
                document.getElementById('innerThresholdInput').addEventListener('input', encodeSetInnerThresholdInput);
                document.getElementById('coverThresholdInput').addEventListener('input', encodeSetCoverThresholdInput);
                document.getElementById('innerThresholdRange').addEventListener('mousedown', disableScroll);
                document.getElementById('coverThresholdRange').addEventListener('mousedown', disableScroll);

                document.getElementById('isCoverGrayCheckBox').addEventListener('change', encodeSetCoverGray);
                document.getElementById('isEncodeReverseCheckBox').addEventListener('change', encodeSetEncodeReverse);

                document.getElementById('encodeMethodSelect').addEventListener('change', encodeSetMethod);
                document.getElementById('encodeSizeInput').addEventListener('input', encodeSetSize);

                document.getElementById('isPngCheckBox').addEventListener('change', setSaveType);
                document.getElementById('jumpToDecodeButton').addEventListener('click', jumpToDecode);
                document.getElementById('encodeSaveImageButton').addEventListener('click', encodeSaveImage);
            }

            // 移除编码事件监听器
            function encodeRemoveEventListeners() {
                document.getElementById('decodeButton').removeEventListener('click', switchPage);
                document.getElementById('innerSourceFileInput').removeEventListener('change', encodeLoadInnerImageFile);
                document.getElementById('coverSourceFileInput').removeEventListener('change', encodeLoadCoverImageFile);
                if (!isOnPhone) {
                    window.removeEventListener('mousemove', updateMousePosition);
                    window.removeEventListener('paste', encodeLoadImageFromClipboard);
                    document.getElementById('innerCanvas').removeEventListener('drop', encodeLoadInnerImageFromDrag);
                    document.getElementById('coverCanvas').removeEventListener('drop', encodeLoadCoverImageFromDrag);
                }
                document.getElementById('innerThresholdRange').removeEventListener('input', encodeSetInnerThreshold);
                document.getElementById('coverThresholdRange').removeEventListener('input', encodeSetCoverThreshold);
                document.getElementById('innerThresholdInput').removeEventListener('input', encodeSetInnerThresholdInput);
                document.getElementById('coverThresholdInput').removeEventListener('input', encodeSetCoverThresholdInput);
                document.getElementById('innerThresholdRange').removeEventListener('mousedown', disableScroll);
                document.getElementById('coverThresholdRange').removeEventListener('mousedown', disableScroll);
                document.getElementById('isCoverGrayCheckBox').removeEventListener('change', encodeSetCoverGray);
                document.getElementById('isEncodeReverseCheckBox').removeEventListener('change', encodeSetEncodeReverse);
                document.getElementById('encodeMethodSelect').removeEventListener('change', encodeSetMethod);
                document.getElementById('encodeSizeInput').removeEventListener('input', encodeSetSize);
                document.getElementById('isPngCheckBox').removeEventListener('change', setSaveType);
                document.getElementById('jumpToDecodeButton').removeEventListener('click', jumpToDecode);
                document.getElementById('encodeSaveImageButton').removeEventListener('click', encodeSaveImage);
            }
        </script>
    </div>
</body>